# Security Policy

## üîí Security Best Practices for Laravel Serial Numbering

This document outlines security considerations when using this package and how to report security vulnerabilities.

---

## Supported Versions

| Version | Supported          |
| ------- | ------------------ |
| 1.1.x   | :white_check_mark: |
| 1.0.x   | :white_check_mark: |
| < 1.0   | :x:                |

---

## üõ°Ô∏è API Security Configuration

### 1. Model Whitelist (Required for API Usage)

The API endpoints accept model class names as input. To prevent arbitrary class instantiation attacks, **you must configure a whitelist** of allowed models:

```php
// config/serial-pattern.php
'api' => [
    'enabled' => true,
    'allowed_models' => [
        \App\Models\Invoice::class,
        \App\Models\Order::class,
        \App\Models\Ticket::class,
        // Add only the models that should be accessible via API
    ],
],
```

**Without this whitelist configured**, the package will reject all model_type parameters for security reasons.

### 2. Authorization & Access Control

The package **does not implement authorization by default**. You must implement your own authorization logic using Laravel's Gate or Policy system.

**Example using Gates:**

```php
// app/Providers/AuthServiceProvider.php
public function boot()
{
    Gate::define('generate-serial', function ($user, $patternType) {
        return $user->hasPermission("serial.generate.{$patternType}");
    });
    
    Gate::define('reset-serial-sequence', function ($user, $patternType) {
        return $user->hasRole('admin');
    });
    
    Gate::define('void-serial', function ($user, $serial) {
        return $user->hasPermission('serial.void');
    });
}
```

**Example Controller with Authorization:**

```php
namespace App\Http\Controllers;

use Illuminate\Support\Facades\Gate;

class CustomSerialController extends Controller
{
    public function generate(Request $request)
    {
        $type = $request->input('type');
        
        // Check authorization
        if (!Gate::allows('generate-serial', $type)) {
            abort(403, 'Unauthorized');
        }
        
        // Proceed with generation
        $serial = app(SerialManager::class)->generate($type);
        
        return response()->json(['serial' => $serial]);
    }
}
```

### 3. Rate Limiting

The package includes rate limiting middleware for API endpoints. Configure appropriate limits:

```php
// config/serial-pattern.php
'api' => [
    'rate_limit' => [
        'enabled' => true,
        'max_attempts' => 60,      // requests per window
        'decay_minutes' => 1,      // time window
    ],
],
```

**For high-traffic applications**, consider:
- Using Redis for rate limiting storage
- Implementing per-user and per-pattern limits
- Adding burst protection with Laravel's built-in rate limiting

### 4. Proxy Configuration

When running behind a proxy, load balancer, or CDN, configure trusted proxies to prevent IP spoofing:

```php
// app/Http/Middleware/TrustProxies.php
protected $proxies = [
    '192.168.1.1',
    '10.0.0.0/8',
    // Add your proxy/load balancer IPs
];

protected $headers = Request::HEADER_X_FORWARDED_ALL;
```

### 5. CSRF Protection

API routes use token-based authentication (Laravel Sanctum) which provides CSRF protection for SPA applications.

**Important:**
- API routes should use `auth:sanctum` middleware
- Do not use session-based authentication for API routes
- If you need session auth, add CSRF middleware explicitly

```php
// For session-based routes (not recommended for APIs)
Route::middleware(['web', 'auth'])->group(function () {
    // These routes will have CSRF protection
});
```

---

## üîê Authentication

### Laravel Sanctum (Required)

API endpoints require Laravel Sanctum for authentication:

```bash
# Install Sanctum if not already installed
composer require laravel/sanctum

# Publish configuration
php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"

# Run migrations
php artisan migrate
```

### Generating API Tokens

```php
// In your authentication controller
$token = $user->createToken('serial-api')->plainTextToken;

return response()->json([
    'token' => $token,
]);
```

### Using API Tokens

```bash
curl -X POST https://api.example.com/api/v1/serial-numbers/generate \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json" \
  -d '{"type": "invoice"}'
```

---

## üö® Known Security Considerations

### 1. Serial Number Predictability

Serial numbers generated by this package are **sequential and predictable**. If this is a security concern for your use case:

**Mitigation Options:**
- Add random segments to patterns: `{random:8}-{number}`
- Implement custom segment resolvers with cryptographic randomness
- Use UUIDs instead of serial numbers for security-sensitive identifiers
- Combine serial with hashed values

**Example:**
```php
'secure_invoice' => [
    'pattern' => 'INV-{hash:8}-{number}',
    // Implement custom {hash} segment resolver
]
```

### 2. Information Disclosure

The package logs serial generation activities. Ensure logs are:
- Stored securely with proper file permissions
- Not accessible via web server
- Rotated regularly
- Excluded from version control

```php
// .gitignore
storage/logs/*.log
```

### 3. Database Security

Serial sequences and logs are stored in the database. Ensure:
- Database credentials are stored in environment variables
- Database user has minimal required privileges
- Sensitive fields are encrypted if needed
- Regular backups are performed

### 4. Audit Trail Integrity

Serial logs use soft-delete prevention (`delete()` throws exception). However:
- Database administrators can still directly modify data
- Consider additional audit controls at database level
- Implement row-level security if using PostgreSQL
- Use database triggers for additional integrity checks

---

## üêõ Reporting Security Vulnerabilities

**Please do not report security vulnerabilities through public GitHub issues.**

Instead, please report security issues by email to:

**Email:** azaharizaman@gmail.com

Please include:
1. Description of the vulnerability
2. Steps to reproduce
3. Potential impact
4. Suggested fix (if any)

You should receive a response within 48 hours. If the issue is confirmed, we will:
1. Release a patch as soon as possible
2. Credit you in the security advisory (unless you prefer to remain anonymous)
3. Publish a security advisory on GitHub

---

## üîÑ Security Updates

Security updates are released as patch versions:
- **1.1.1** - Security patches for 1.1.x
- **1.0.1** - Security patches for 1.0.x

**Recommended:** Always use the latest patch version of your major/minor release.

To check for updates:
```bash
composer outdated azaharizaman/laravel-serial-numbering
```

To update to the latest secure version:
```bash
composer update azaharizaman/laravel-serial-numbering
```

---

## üìã Security Checklist

Before deploying to production:

- [ ] Configure model whitelist in `config/serial-pattern.php`
- [ ] Implement authorization checks for all serial operations
- [ ] Configure trusted proxies if behind load balancer
- [ ] Set up rate limiting with appropriate limits
- [ ] Secure API routes with Laravel Sanctum
- [ ] Review log storage permissions and rotation
- [ ] Secure database credentials in environment variables
- [ ] Test with security scanning tools (e.g., OWASP ZAP)
- [ ] Review and sanitize any custom segment resolvers
- [ ] Document security requirements for your team

---

## üîó Additional Resources

- [Laravel Security Best Practices](https://laravel.com/docs/security)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Laravel Sanctum Documentation](https://laravel.com/docs/sanctum)
- [Package Security Advisories](https://github.com/azaharizaman/laravel-serial-numbering/security/advisories)

---

**Last Updated:** 2025-11-10  
**Version:** 1.1.0
